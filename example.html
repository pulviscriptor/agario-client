<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>agario-client browser example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/EventEmitter/4.2.11/EventEmitter.min.js"></script>
    <script src="https://cdn.rawgit.com/anodynos/node2web_buffer/44f2813c8818bfb7aa6af585d5d51250d9555131/buffer.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/pixi.js/3.0.6/pixi.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5/dat.gui.min.js"></script>
    <script src="agario-client.js"></script>
</head>

<body>
    <script>
        var client = new Client('worker'); //create new client and call it "worker" (not nickname)

        // Rendering
        function BallView(main, ball) {
            this.main = main;
            this.ball = ball;
            this.graphic = new PIXI.Graphics();
            this.draw();
            this.main.stage.addChild(this.graphic);

            var _this = this;
            this.ball.once('disappear', function() {
                _this.erase();
            });
            this.ball.once('destroy', function() {
                _this.erase();
            });
            this.ball.on('move', function() {
                _this.move();
            });
            this.ball.on('resize', function() {
                _this.shape();
            });
        }

        BallView.prototype = {
            draw: function() {
                this.shape();
                this.move();
            },
            shape: function() {
                this.graphic.clear();
                this.graphic.beginFill(this.ball.color.replace('#', '0x'), 1);
                this.graphic.drawCircle(0, 0, this.ball.size * this.main.scale);
                this.graphic.endFill();
            },
            move: function() {
                this.graphic.position.x = this.ball.x * this.main.scale;
                this.graphic.position.y = this.ball.y * this.main.scale;
            },
            erase: function() {
                this.graphic.clear();
                this.main.stage.removeChild(this.graphic);
            }
        };


        function Viewer(client) {
            this.client = client;

            _this = this;
            client.once('mapSizeLoad', function(min_x, min_y, max_x, max_y) {
                _this.gameWidth = max_x;
                _this.gameHeight = max_y;
                _this.calculateScale();
                _this.addRenderer();
                _this.initStage();
                _this.addListners();
                _this.animate();
                _this.emit('launched')
            });
        }

        var MARGIN = 20;

        Viewer.prototype = {
            calculateScale: function() {
                allowedX = window.innerWidth - MARGIN;
                allowedY = window.innerHeight - MARGIN;
                scaleX = allowedX / this.gameWidth;
                scaleY = allowedY / this.gameHeight;
                this.scale = Math.min(scaleX, scaleY);
            },
            addRenderer: function() {
                this.width = Math.ceil(this.gameWidth * this.scale);
                this.height = Math.ceil(this.gameHeight * this.scale);
                this.renderer = PIXI.autoDetectRenderer(this.width, this.height, {
                    antialias: true
                });
                document.body.appendChild(this.renderer.view);
            },
            initStage: function() {
                this.stage = new PIXI.Container();
                this.stage.interactive = true;
            },
            addListners: function() {
                var _this = this;
                this.client.on('ballAppear', function(id) {
                    new BallView(_this, client.balls[id]);
                });
            },
            animate: function() {
                this.renderer.render(this.stage);
                var _this = this;
                requestAnimationFrame(function() {
                    _this.animate();
                });
            }
        };

        // Inherit from EventEmitter
        for (key in EventEmitter.prototype) {
            Viewer.prototype[key] = EventEmitter.prototype[key];
        }

        function Pointer(viewer) {
            this.viewer = viewer;
            this.client = this.viewer.client;
            var _this = this;
            this.viewer.once('launched', function() {
                _this.viewer.renderer.view.addEventListener('mousemove', function(e) {
                    _this.client.moveTo(e.offsetX / _this.viewer.scale, e.offsetY / _this.viewer.scale)
                })
            })
        }

        function Controller(client) {
            this.client = client;

            this.nick = 'agario-client';
            this.autoRespawn = false;
            this.server = {
                region: 'EU-London',
                ip: '127.0.0.1',
                port: 9158
            }

            this.gui = new dat.GUI();

            this.servgui = this.gui.addFolder('Server');
            this.servgui.add(this.server, 'region')
            this.servgui.add(this, 'findServer')
            this.servgui.add(this.server, 'ip')
            this.servgui.add(this.server, 'port')
            this.servgui.add(this, 'connect')
            this.servgui.add(this, 'disconnect')
            this.servgui.open()

            this.cellgui = this.gui.addFolder('Cell');
            this.cellgui.add(this, 'nick');
            this.cellgui.add(this, 'spawn');
            this.cellgui.add(this, 'autoRespawn');

            this.leadergui = this.gui.addFolder('Leaderboard');
            this.leaders = {};
            for (var i = 1; i <= 10; i++) {
                this.leaders[i] = '---';
                this.leadergui.add(this.leaders, i);
            }

            var _this = this;
            client.on('connected', function() {
                _this.servgui.close()
                _this.cellgui.open()
                _this.leadergui.open()
            });
            client.on('reset', function() {
                _this.servgui.open()
                _this.cellgui.close()
                _this.leadergui.close()
            });
            client.on('lostMyBalls', function() {
                if (_this.autoRespawn) {
                    _this.spawn();
                }
            })
            client.on('leaderBoardUpdate', function(old, leaders) {
                for (var i in leaders) {
                    var rank = parseInt(i) + 1;
                    _this.leaders[rank] = this.balls[leaders[i]].name || 'An unnamed cell';
                    for (var i in _this.leadergui.__controllers) {
                        _this.leadergui.__controllers[i].updateDisplay();
                    }

                }
            });
        }

        Controller.prototype = {
            findServer: function() {
                // TODO Dummy
                // Anyway, due to connection being blocked on any official server,
                // this will likely never work
                x = new XMLHttpRequest()
                x.open('POST', 'http://m.agar.io', false);
                x.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                // x.setRequestHeader('Content-Length', region.length);
                x.setRequestHeader('Origin', 'http://agar.io');
                x.setRequestHeader('Referer', 'http://agar.io/');
                x.send(this.server.region);
                s = x.responseText.split(':')
                this.server.ip = s[0];
                this.server.port = s[1];

                for (var i in this.servgui.__controllers) {
                    this.servgui.__controllers[i].updateDisplay();
                }
            },
            connect: function() {
                this.client.connect('ws://' + this.server.ip + ':' + this.server.port)
            },
            disconnect: function() {
                this.client.disconnect();
            },
            spawn: function() {
                this.client.spawn(this.nick)
            },
        }

        var viewer = new Viewer(client);
        var controller = new Controller(client);
        var pointer = new Pointer(viewer);

        // client.connect("ws://127.0.0.1:9158");
    </script>

</body>

</html>